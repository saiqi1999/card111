# Cardgame111 - 卡牌游戏项目

这是一个使用Godot 4.4.1引擎开发的卡牌游戏项目。

## 项目结构

- `assets/` - 游戏资源文件夹
  - `images/` - 图像资源
- `scenes/` - 游戏场景文件夹
  - `root.tscn` - 主场景
  - `card.tscn` - 卡牌场景
  - `debug.tscn` - 调试场景
- `scripts/` - 游戏脚本文件夹
  - `cards/` - 卡牌系统相关脚本
  - `debug/` - 调试相关脚本
  - `mobs/` - 怪物相关脚本
  - `utils/` - 全局工具脚本
  - `ctrl/` - 简化的UI控制器系统
    - `camera_ctrl.gd` - 相机控制器
    - `prefabs/` - UI组件目录
      - `ctrl_400_300.gd` - 信息面板（Autoload单例）

## 功能概述

### 卡牌系统

项目实现了完整的卡包系统和卡牌交互功能：

- `CardPackBase` - 卡包基类，提供卡牌管理的基本功能
- 支持30种不同类型的卡牌预制件，包括：
   - 基础卡牌：打击、防御、蓝莓、基础技能包、Want Slime
   - 自然元素：下雨、刮风、向导之书、木材、森林道路、碎木头
   - 地元素奥秘：地元素奥秘0级、地元素奥秘1级、水元素奥秘0级、未激活的奥秘
   - 石材相关：奇怪石堆、石堆、燧石、石块、土堆
   - 工具道具：铁斧、铁铲、十字镐、镰刀、初级花盆
   - 植物相关：大蓝莓丛、小蓝莓丛、大魔法气息、小魔法气息
   - 建筑物：旧木屋
- `CardUtil` - 卡牌工具类，提供卡牌显示、拖拽、移动、堆叠和移除功能
- 全卡牌预制件展示功能，支持网格布局显示所有卡牌类型

### 控制器系统

控制器系统用于在游戏中显示和管理各种UI界面，如背包、商店界面等。采用Control+简化位置设置的UI实现方式，并使用Godot的Autoload机制实现单例模式。

- **Control实现**：基于Godot原生Control节点，享受完整的UI系统支持
- **简化布局**：使用简单的位置设置替代复杂的Anchor系统，避免显示问题
- **响应式缩放**：控制器尺寸根据屏幕分辨率动态调整为屏幕的四分之一
- **固定定位**：控制器固定在左下角，距离边缘100像素
- **Autoload单例**：使用Godot官方推荐的Autoload机制实现单例模式，确保全局唯一性
- **全局访问**：通过Autoload名称（如Ctrl400x300）在任何脚本中直接访问
- **内存安全**：Godot引擎自动管理Autoload生命周期，避免内存泄漏
- **动态内容**：支持动态设置标题和描述，适应不同使用场景
- **类型系统**：通过类型字符串管理不同控制器类型，易于扩展
- **生命周期管理**：完善的创建、初始化和销毁流程
- **UI层级**：基于Control的自然层级管理，无需手动设置z_index
- **纹理背景**：支持StyleBoxTexture背景纹理显示，提供丰富的视觉效果
- **模块化设计**：采用基类+子类架构，支持不同类型控制器的扩展

#### 卡牌交互功能

- **卡牌拖拽**：支持鼠标拖拽卡牌，使用全局鼠标跟踪技术，无论移动多快都能精确跟随
- **动画系统**：支持卡牌平滑移动动画，使用Tween系统实现
- **冲突处理**：拖拽时自动停止正在进行的移动动画，避免冲突
- **模块化设计**：`move_card`方法独立实现，支持代码复用
- **层级管理**：实现了卡牌层级管理系统，解决多张卡牌重叠时的点击检测问题
- **智能点击**：只有最上层的卡牌响应鼠标点击，点击时自动置顶
- **卡牌注册**：自动管理所有卡牌实例，支持失效卡牌的自动清理
- **个性化点击效果**：每张卡牌支持自定义点击效果，通过`on_click`属性实现个性化交互
- **卡牌移除系统**：`remove`方法支持安全移除卡牌，自动处理堆叠更新、卡牌注销和状态重置
- **堆叠状态管理**：移除卡牌时自动从当前堆叠中移除，更新堆叠映射关系，确保数据一致性

### 配方合成系统

项目实现了完整的卡牌合成配方系统，支持卡牌之间的自动合成：

- `RecipeUtil` - 配方管理工具类（Autoload单例），负责管理卡牌合成配方
- `CraftingProgressBar` - 合成进度条UI组件，提供可视化的合成进度显示
- **自动检测**：当卡牌形成堆叠时自动检查是否匹配配方
- **合成管理**：支持合成进度控制和时间管理
- **进度条显示**：合成过程中显示可视化进度条，实时反映合成进度
- **回调机制**：合成完成后自动调用参与卡牌的`after_recipe_done`方法，传递卡牌实例和参与合成的卡牌列表
- **默认配方**：铁铲 + 土堆 → 初级花盆（合成时间5秒）

#### 配方合成功能

- **动态配方注册**：支持运行时注册新的合成配方
- **智能堆叠检测**：卡牌堆叠时自动触发配方匹配检查
- **异步合成处理**：合成过程不阻塞游戏主线程
- **进度跟踪**：实时跟踪合成进度和剩余时间
- **可视化进度条**：合成过程中显示进度条，支持自定义位置和样式
- **产物生成**：合成完成后自动生成目标卡牌
- **事件回调**：支持合成前后的自定义处理逻辑
- **堆叠更新**：卡牌移除时自动更新堆叠状态，确保数据一致性
- **计数器系统**：支持卡牌包内置计数器，实现特殊逻辑（如土堆3次合成后自动回收）
- **连续合成**：支持连续合成功能，合成完成后自动检查是否可以继续合成

#### 合成进度条系统

- **自定义UI组件**：基于Control节点的独立进度条组件
- **动态位置调整**：进度条位置相对于卡牌堆叠自动调整（向左移动半个卡牌宽度，向上移动半个卡牌高度）
- **实时进度更新**：合成过程中实时更新进度条显示
- **自动生命周期管理**：进度条在合成开始时显示，完成后自动隐藏和销毁
- **样式自定义**：支持自定义进度条颜色、高度和背景样式
- **位置同步**：卡牌移动时进度条位置自动同步更新

### 全局工具系统

项目实现了全局工具系统、统一的日志管理和全局常量配置：

- `GlobalUtil` - 全局工具类，提供通用工具方法和日志管理
- `GlobalConstants` - 全局常量类，定义游戏中使用的所有常量配置
- `GlobalUtilLoader` - 全局工具加载器，负责初始化全局工具实例和常量

#### 日志系统功能

- **统一日志接口**：所有打印操作通过`GlobalUtil.log`方法统一管理
- **日志级别**：支持DEBUG、INFO、WARNING、ERROR四个级别
- **动态控制**：运行时可通过命令开启/关闭日志输出
- **性能优化**：关闭日志输出可显著提升游戏性能

#### 全局常量系统功能

- **统一配置**：所有游戏常量集中在`GlobalConstants`类中管理
- **类型安全**：使用强类型定义，避免硬编码错误
- **易于维护**：修改常量值只需在一个地方进行
- **配置分类**：按功能分类组织常量（卡牌、动画、屏幕位置等）
- **自动加载**：通过`GlobalUtilLoader`自动注册为全局单例

### 调试界面

调试场景提供了丰富的测试功能：

#### 按钮功能
- 点击按钮创建三张不同位置的卡牌

#### 命令系统
调试界面支持以下命令（在输入框中输入并按回车）：
- `hello` - 显示问候信息
- `reboot` - 重启root节点，清除所有卡牌并重新初始化
- `slide` - 创建滑动卡牌，从屏幕左侧滑动到中央
- `random` - 创建随机移动卡牌，移动到非中心区域
- `overlap` - 创建5张重叠卡牌，测试层级管理功能（使用卡牌池系统，解决首次拖拽延迟问题）
- `listall` - 展示所有30种卡牌预制件，使用网格布局整齐排列
- `log on` - 开启日志输出
- `log off` - 关闭日志输出
- `help` - 显示所有可用命令和当前日志状态

#### 卡牌交互
- **拖拽功能**：所有创建的卡牌都支持鼠标拖拽，支持单张和多张卡牌拖拽
- **层级管理**：重叠卡牌时只有最上层响应点击，拖拽时自动将卡牌组移到最前面
- **智能点击**：单纯点击不改变卡牌层级，只有拖拽时才将卡牌移到最前面
- **卡牌堆叠**：支持卡牌堆叠功能，可将多张卡牌组合成堆叠
- **连带拖拽**：拖拽堆叠中的卡牌时，会连带拖拽堆叠中的其他卡牌

## 开发计划

### 已完成功能
- [x] 卡包系统基础架构
- [x] 卡牌显示和交互系统
- [x] 卡牌拖拽和动画系统
- [x] 全局工具系统
- [x] 统一日志管理系统
- [x] 卡牌层级管理系统
- [x] 调试界面和命令系统
- [x] 控制器系统基础架构
- [x] 控制器UI布局和响应式设计
- [x] 控制器Autoload单例模式实现
- [x] 控制器动态标题描述系统
- [x] 控制器纹理背景显示系统
- [x] 控制器与卡牌系统的Autoload集成
- [x] 多种卡牌类型实现（30种卡牌预制件，包括基础卡牌、元素奥秘、工具道具等）
- [x] 全卡牌预制件展示功能实现
- [x] 网格布局卡牌展示系统
- [x] 代码结构优化和重构
- [x] 控制器类型系统和扩展机制
- [x] 控制器与卡牌系统集成
- [x] 控制器UI元素显示和布局优化
- [x] 控制器简化位置设置系统（替代复杂Anchor系统）
- [x] 控制器可见性问题修复和显示优化
- [x] 卡牌堆叠系统实现
- [x] 卡牌智能点击逻辑优化
- [x] 多张卡牌连带拖拽功能
- [x] 卡牌层级管理系统优化
- [x] 配方合成系统基础架构
- [x] 合成进度条UI组件实现
- [x] 合成进度条位置调整和样式自定义
- [x] 合成进度条生命周期管理
- [x] 合成进度条与卡牌移动同步
- [x] 连续合成功能实现
- [x] 合成进度条管理代码重构和优化

### 待开发功能
- [ ] 实现卡牌基类
- [ ] 实现怪物基类
- [ ] 实现战斗系统
- [ ] 实现回合系统
- [ ] 实现资源系统

## 开发环境

- Godot 4.4.1
- GDScript

## 如何运行

1. 使用Godot 4.4.1或更高版本打开项目
2. 点击编辑器中的运行按钮或按F5启动游戏